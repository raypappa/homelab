---
# yaml-language-server: $schema=https://raw.githubusercontent.com/ansible/ansible-lint/main/src/ansiblelint/schemas/ansible.json#/$defs/tasks
- name: k3s pre-requisites
  ansible.builtin.import_role:
    name: _k3s_prereq
- name: Create kubectl symlink
  ansible.builtin.file:
    src: /usr/local/bin/k3s
    dest: /usr/local/bin/kubectl
    state: link
- name: Create crictl symlink
  ansible.builtin.file:
    src: /usr/local/bin/k3s
    dest: /usr/local/bin/crictl
    state: link
- name: Download and install Helm
  become: true
  ansible.builtin.unarchive:
    src: https://get.helm.sh/helm-v{{ helm_version }}-linux-{{ helm_arch[ansible_architecture]
      }}.tar.gz
    remote_src: true
    extra_opts:
      - --strip-components=1
    include:
      - linux-{{ helm_arch[ansible_architecture] }}/helm
    mode: "0555"
    owner: root
    group: root
    dest: /usr/local/bin
- name: Harden the things we can before creating the cluster
  ansible.builtin.import_tasks: harden.yaml
  become: true
- name: Setup Cluster Singleton
  ansible.builtin.import_tasks: singleton.yml
  run_once: true
  become: true
- name: Setup Remaining Cluster Nodes
  ansible.builtin.include_tasks:
    file: cluster.yml
  when: inventory_hostname != k3s_controlplane_singleton_host

# TODO: Check that the number of available nodes in k3s matches the number of hosts in inventory

- name: Bootstrap ArgoCD
  ansible.builtin.import_tasks: argocd.yml
  run_once: true
  become: true
